# 心跳和重启

## 心跳机制

心跳机制是 Keeper 的核心机制，节点在每分钟 0 秒时心跳。Keeper 程序由多个组件（Actor）组成，每个组件执行不同的功能。Keeper 的心跳会传递给这些组件，即让这些组件也进行心跳。所以，如果组件的心跳时间离当前时间太远，说明节点出现了问题。

这些组件包括：

* Keeper 核心组件。
* 系统检查组件，执行系统的各种附属功能，如自动启停调度、清理日志等。
* 任务生产组件，用于创建任务实例，并向任务检查组件发送待检查任务。
* 任务启动组件，用于向任务执行组件发送待执行任务。
* 任务检查组件，检查任务的前置依赖。
* 任务执行组件，执行可执行的命令或脚本。
* 任务日志记录组件，记录任务运行过程中产生的日志并保存在文件中。
* 无限循环任务处理组件，处理并记录无限循环任务的执行和等待间隔，并将可执行的循环任务发送给任务执行组件。
* 即时查询处理组件，接受即时查询请求并处理。
* 即时查询执行组件，执行即时查询任务。

## 重启和关机

一般情况下， Keeper 在运行起来之后无需关机或重启。重启功能主要为了升级版本需要或应对不可预知的特殊情况。
重启需要预先设置 crontab，请参照[安装 Qross 系统](/qross/install.md)。如果没有设置 crontab 或关闭了 crontab，则会退出 Keeper 程序。即 crontab 是对 Keeper 的保护，防止 Keeper 异常退出，在检测不到 Keeper 进程时，会自动重启 Keeper。

重启功能不同于在操作系统中的 kill 命令，重启过程如下：

* Keeper 核心组件向各组件发送退出命令。
* 各组件接收到命令后依次退出，不再接受新的指令。
* 已执行任务必须在执行完成后才能退出，但可以使用“强制退出”，但会让已执行的任务失去控制。
* Keeper 组件退出。
* Http 服务关闭。
* 退出程序。

重启过程比较慢，因为需要等待已运行的调度任务执行完且各个组件关闭，所以建议在调度任务运行少的时间段进行重启。重新过程中可以“强制关闭”，但强烈不建议这么做，强制关闭只会杀掉 Keeper 进程，但不会中断正在运行的调度任务。在 Keeper 重启时，Keeper 会重新启动未执行完的任务，所以可能会造成这些调度任务的结果不正确。

在重启过程中，会在页面上不断刷新 Keeper 运行日志，可根据运行日志了解 Keeper 的启动过程。Keeper Http 服务关闭后不再能获取 Keepr 运行日志，会提示红色的 “Connection refused: connect”。

---
参考链接

* [升级 Qross 系统](/qross/upgrade.md)
* [安装 Qross 系统](/qross/install.md)
