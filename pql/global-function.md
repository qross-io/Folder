# 全局系统函数

和任何数据库的 SQL 语言一样，PQL 支持系统函数，可以像使用变量一样嵌入到语句的任何地方。所以 PQL 不仅可以通过 Sharp 表达式操作数值，还可以使用函数。

```sql
SELECT * FROM students WHERE initial=@LEFT($name, 1);
```

上例效果与下列 [Sharp 表达式操作](/pql/sharp-text.md)相同。

```sql
SELECT * FROM students WHERE initial=${ $name TAKE 1 };
```

与[全局变量](/pql/global-variable.md)一样，系统函数使用`@`开头。虽然大多数情况下功能与 [Sharp表达式](/pql/sharp.md)相同，但 PQL 仍建议使用 [Sharp 表达式](/pql/sharp.md)作为处理数据的手段。一个原因是避免混乱，因为所有原生的 SQL 都支持函数，而且名称有的会与 PQL 函数相同，区别只是差别一个`@`号；二是为了避免逻辑不清，各数据库的原生函数作用于每行数据，而 PQL 函数只作用于单值。

函数与其他嵌入式操作的优先级顺序为：**用户变量** 优先于 **系统变量** 优先于 **自定义或全局函数** 优先于 **Sharp 表达式**，所以可以在函数中把变量当作函数的参数，也可以在 Sharp 表达式运算过程中使用函数。

为了照顾不同的数据库 SQL 语言习惯，PQL 中会有不同的函数名称来完成同一个操作。目前系统支持的全局函数比较少，会随着版本更新不断补全。

* [字符串处理函数](/pql/function-text.md)
* [数字相关函数](/pql/function-numeric.md)

## 自定义系统函数

可以定义自己的系统函数，可以作用于整个系统，可以在任何 PQL 中使用。只能使用 [Master 管理工具](/master/overview.md)在系统设置的[系统函数](/master/system/functions.md)中定义。/s:另外一种方式是使用下面的语句定义系统函数，但如果没有 Qross 系统支持，则其作用基本与用户函数相同，在运行 PQL 的程序退出时即失效。（会在未来版本中支持）/

```sql
FUNCTION @CUSTOM_FUNC_NAME ($a, $b DEFAULT 1)
    BEGIN
        -- statement
        RETURN $a + $b;
    END
```

自定义系统函数的结构与[用户函数](/pql/function.md)相同，只是前缀符号由`$`改为`@`，与用户变量与全局变量的逻辑相同。自定义系统函数在调用时也加`@`前缀符号，与系统函数相同。自定义系统函数主要分为三部分：

* 函数名称，以`@`开始，由英文字母、数字和下划线`_`组成，名称建议全部大写，单词之间使用`_`隔开。函数名称在整个系统中唯一，自定义函数不能与系统原有函数名冲突。
* 函数参数，参数名称以`$`开始，名称一般为全部小写，单词之间使用`_`隔开。使用`DEFAULT`关键词设定默认值。
* 函数体，是一个独立的 PQL 过程。通过 RETURN 语句或 OUTPUT 语句返回值，可以没有返回值，当作过程使用。没有返回值时不能嵌入到其他语句中，只能通过 CALL 语句调用。

即除了名称以`@`开头以外，其他逻辑都与[用户函数](/pql/function.md)相同。

## 使用 PQL 系统函数

对于返回值的系统函数，可以嵌入到其他语句中使用，就像全局变量一样。

```sql
SELECT id, name, age, score FROM students WHERE grade=@LOWER($grade);

FOR $a OF @GET_STUDENTS() LOOP
    -- statement .....
END LOOP;
```

对于没有返回值但是实现业务逻辑的系统函数，可以使用 [CALL 语句](/pql/call.md)调用。

```sql
CALL @COUNT_STUDENT_SCORES($class := 1);
```

为了表达更清晰，对于无参系统函数，可以省略小括号，例如`@KEEPER_IS_RUNNING`。更多信息可参考 [CALL 语句](/pql/call.md)。

## 函数之间的区别和差异

PQL 提供了 **用户函数**、**系统函数** 和 **自定义系统函数** 三种概念，不同类型的函数之间具有一定的差异，现分别说明如下：

* 所有函数都可嵌入到其他语句中，但这时要求这个函数返回必须为单值，而不能是复合值，如可以是数字、字符串、日期时间、布尔值等，但不能是数组、数据行、数据表等。
* 用户函数和自定义系统函数类似，都可以返回任何类型的值，也可以不返回值。因为都是由 PQL 编写，所以可以作为“处理过程”使用，以实现类似数据库中存储过程的功能。作为过程使用时，可以使用 [CALL 语句](/pql/call.md)调用。
* 用户函数和自定义系统函数执行方式不同，用户函数内部可以使用当前 PQL 过程的全局变量和数据连接，执行时也与当前 PQL 过程是一体的，类似于 IF 或 FOR 语句内的语句块逻辑。但自定义系统函数不能使用当前 PQL 过程的任何信息，只能以函数参数的形式传递数据。而且自定义函数的执行也是独立的，可以理解为一个独立的 PQL 过程，执行完成之后将结果返回给当前 PQL 过程。
* 系统函数都是内置的系统方法，不能作为过程使用，只能嵌入到其他语句中，用于处理单值或聚合。一般也不使用 [CALL 语句](/pql/call.md)调用。将来会扩展更多用途。
* 用户函数的作用域只在当前 PQL 过程内，系统函数和自定义系统函数可以在任何 PQL 中使用。
* 如果自定义系统函数和系统函数同名，则优先调用自定义系统函数，因此可以通过这种方法重写（override）原生系统函数。

## 系统函数的所有者

在 Qross 系统中，任何用户都可以定义系统函数，但是只有系统管理员可以在系统设置中定义适用于所有用户的系统函数，所有用户在 Qross 系统“数据”模块定义的系统函数只有本人可以在自己编写的 PQL 中使用。在数据权限不敏感的情况下，建议由系统管理员定义系统函数。如果个人系统函数和全局系统函数名称相同，则优先调用个人系统函数。

---
参考链接

* [用户函数 FUNCTION](/pql/function.md)
* [函数调用 CALL](/pql/call.md)
